name: CI - Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Backend Tests (Spring Boot) - DESABILITADO
  # backend-springboot-tests:
  #   name: Backend - Java 21 + Spring Boot
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - name: Checkout código
  #     uses: actions/checkout@v4
  #
  #   - name: Setup Java 21
  #     uses: actions/setup-java@v4
  #     with:
  #       distribution: 'temurin'
  #       java-version: '21'
  #       cache: 'maven'
  #
  #   - name: Cache Maven dependencies
  #     uses: actions/cache@v4
  #     with:
  #       path: ~/.m2/repository
  #       key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
  #       restore-keys: |
  #         ${{ runner.os }}-maven-
  #
  #   - name: Build e Test Backend
  #     working-directory: ./backend-springboot
  #     run: |
  #       mvn clean verify
  #       mvn test
  #
  #   - name: Gerar relatório de cobertura
  #     working-directory: ./backend-springboot
  #     run: mvn jacoco:report
  #
  #   - name: Upload cobertura para Codecov
  #     uses: codecov/codecov-action@v4
  #     with:
  #       files: ./backend-springboot/target/site/jacoco/jacoco.xml
  #       flags: springboot-backend
  #       name: springboot-coverage

  # Job 2: Backend Tests (ASP.NET Core) - DESABILITADO
  # backend-aspnet-tests:
  #   name: Backend - .NET 8 + ASP.NET Core
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - name: Checkout código
  #     uses: actions/checkout@v4
  #
  #   - name: Setup .NET 8
  #     uses: actions/setup-dotnet@v4
  #     with:
  #       dotnet-version: '8.0.x'
  #
  #   - name: Cache NuGet packages
  #     uses: actions/cache@v4
  #     with:
  #       path: ~/.nuget/packages
  #       key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
  #       restore-keys: |
  #         ${{ runner.os }}-nuget-
  #
  #   - name: Restore dependencies
  #     working-directory: ./backend-aspnet/PetshopApi.Tests
  #     run: dotnet restore
  #
  #   - name: Build projeto
  #     working-directory: ./backend-aspnet/PetshopApi.Tests
  #     run: dotnet build --no-restore
  #
  #   - name: Run tests with coverage
  #     working-directory: ./backend-aspnet/PetshopApi.Tests
  #     run: dotnet test --no-build --verbosity normal /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
  #
  #   - name: Upload cobertura para Codecov
  #     uses: codecov/codecov-action@v4
  #     with:
  #       files: ./backend-aspnet/PetshopApi.Tests/coverage.opencover.xml
  #       flags: aspnet-backend
  #       name: aspnet-coverage

  # Job 3: Frontend Tests (Playwright)
  frontend-tests:
    name: Frontend - Playwright E2E
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}

    - name: Instalar dependências
      run: npm ci

    - name: Instalar browsers Playwright
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright install --with-deps
    
    - name: Instalar apenas dependências dos browsers
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      run: npx playwright install-deps

    - name: Setup Java 21 (para backend)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

    - name: Iniciar Backend (background)
      working-directory: ./backend-springboot
      run: |
        mvn spring-boot:run -DskipTests &
        echo $! > backend.pid
        # Aguardar backend estar pronto (reduzido para 60s)
        timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health 2>/dev/null; do sleep 2; done' || true

    - name: Executar testes Playwright (apenas Chromium no CI)
      run: npx playwright test --project=chromium
      env:
        CI: true

    - name: Parar Backend
      if: always()
      run: |
        if [ -f backend-springboot/backend.pid ]; then
          kill $(cat backend-springboot/backend.pid) || true
        fi

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Upload Screenshots de Falhas
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-screenshots
        path: test-results/
        retention-days: 7

  # Job 4: Code Quality - DESABILITADO
  # code-quality:
  #   name: Análise de Qualidade
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - name: Checkout código
  #     uses: actions/checkout@v4
  #     with:
  #       fetch-depth: 0  # Necessário para SonarCloud
  #
  #   - name: Setup Java 21
  #     uses: actions/setup-java@v4
  #     with:
  #       distribution: 'temurin'
  #       java-version: '21'
  #       cache: 'maven'
  #
  #   - name: SonarCloud Scan (se configurado)
  #     working-directory: ./backend-springboot
  #     env:
  #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #     run: |
  #       if [ -n "$SONAR_TOKEN" ]; then
  #         mvn verify sonar:sonar \
  #           -Dsonar.projectKey=andreaspsb_Fundamentos-de-Sistemas-Web-Com-BackEnd \
  #           -Dsonar.organization=andreaspsb \
  #           -Dsonar.host.url=https://sonarcloud.io
  #       else
  #         echo "SonarCloud não configurado - pulando"
  #       fi
  #     continue-on-error: true

  # Job 5: Build Success Notification
  notify-success:
    name: Notificação de Sucesso
    needs: [frontend-tests]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Build passou ✅
      run: |
        echo "✅ Todos os testes passaram!"
        echo "✅ Testes Playwright: OK"
